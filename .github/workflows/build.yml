name: Build V Project

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install V
        run: |
          git clone https://github.com/vlang/v
          cd v
          .\make.bat
          echo "$PWD" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Build V project (Windows)
        run: |
          v -enable-globals -os windows -o v-hill.exe src

      - name: Upload Windows EXE
        uses: actions/upload-artifact@v4
        with:
          name: v-hill-windows
          path: v-hill.exe

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest

    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup QEMU (for arm64 build)
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3

      - name: Run build in Docker (cross-platform)
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/project \
            --platform=linux/${{ matrix.arch }} \
            ubuntu:latest \
            bash -c "\
              apt update && \
              apt install -y git build-essential curl && \
              cd /project && \
              git clone https://github.com/vlang/v && \
              cd v && make && \
              export PATH=\$PWD:\$PATH && \
              cd /project && \
              v -enable-globals -os linux -o v-hill-${{ matrix.arch }} src"

      - name: Upload Linux Binary
        uses: actions/upload-artifact@v4
        with:
          name: v-hill-linux-${{ matrix.arch }}
          path: v-hill-${{ matrix.arch }}
